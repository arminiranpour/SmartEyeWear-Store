@model SmartEyewearStore.Models.ProductDetailsViewModel
@{
    ViewData["Title"] = Model.Name;
}

@section Head {
    @if (ViewData["Canonical"] != null)
    {
        <link rel="canonical" href="@ViewData["Canonical"]" />
    }
}

<section id="product-info" style="background-color: rgb(245,245,245);">
    <div class="container mx-auto">
        <div class="py-8 lg:py-10">
            <div class="flex flex-col lg:flex-row items-start gap-8 lg:gap-12">
                <!-- ستون چپ: گالری -->
                <div class="w-full lg:w-1/2">
                    <div class="grid gap-4">
                        @{
                            var selected = Model.Variants.First(v => v.VariantId == Model.SelectedVariantId);
                            var mainImage = selected.Images.LastOrDefault();
                        }
                        <div id="main-image-container" class="w-full h-80 max-w-full overflow-hidden rounded-lg flex items-center justify-center bg-gray-100">
                            <img id="main-image" class="h-full w-full object-contain rounded-lg" src="@mainImage?.Url" alt="@mainImage?.Alt" />
                        </div>
                        <div class="grid grid-cols-5 gap-4">
                            @foreach (var img in selected.Images)
                            {
                                <div class="h-20 w-full overflow-hidden rounded-lg flex items-center justify-center bg-gray-100">
                                    <img onclick="changeImage(this)" data-full="@img.Url" src="@img.Url" class="h-full w-full object-contain rounded-lg cursor-pointer" alt="@img.Alt" />
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- ستون راست: کارت سفید -->
                <div class="w-full lg:w-1/2">
                    <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8 space-y-6">
                        @{
                            var price = selected.Price;
                            bool onSale = price?.IsOnSale == true && price?.SalePriceCents != null && price.BasePriceCents > 0;
                            decimal baseP = price?.BasePriceCents / 100m ?? 0m;
                            decimal saleP = onSale ? (price!.SalePriceCents!.Value / 100m) : baseP;
                            int? off = onSale ? (int?)Math.Round(100m * (baseP - saleP) / baseP) : null;

                            var rating = Model.AvgRating ?? 0m;
                            var ratingCount = Model.RatingCount ?? 0;
                            int full = (int)Math.Floor(rating);
                            bool half = (rating - full) >= 0.5m && full < 5;
                            int empty = 5 - full - (half ? 1 : 0);
                        }

                        <!-- اسم محصول -->
                        <h1 class="text-3xl font-extrabold leading-tight">@Model.Name</h1>

                        <!-- برند -->
                        @if (!string.IsNullOrWhiteSpace(Model.Brand))
                        {
                            <p class="text-gray-600 text-base">@Model.Brand</p>
                        }

                        <!-- ریویوها (ستاره از DB + فقط تعداد) -->
                        <div class="flex items-center gap-3">
                            <div class="flex text-lg leading-none">
                                @for (int i = 0; i < full; i++)
                                {
                                    <i class="fa-solid fa-star text-yellow-400 mr-1"></i>
                                }
                                @if (half)
                                {
                                    <i class="fa-solid fa-star-half-stroke text-yellow-400 mr-1"></i>
                                }
                                @for (int i = 0; i < empty; i++)
                                {
                                    <i class="fa-regular fa-star text-gray-300 mr-1"></i>
                                }
                            </div>
                            <a href="#reviews-content" class="text-primary font-semibold hover:underline">@ratingCount Reviews</a>
                        </div>

                        <!-- واریانت‌ها (دکمه‌های نام رنگ) -->
                        <div class="space-y-2">
                            <p class="text-sm text-gray-700">Available Variants</p>
                            <div class="flex flex-wrap gap-3">
                                @foreach (var v in Model.Variants)
                                {
                                    var isSel = v.VariantId == Model.SelectedVariantId;
                                    var label = v.ColorName;
                                    <a href="@Url.Action("Details", "Product", new { slug = Model.Slug, variantId = v.VariantId })"
                                       class="inline-flex items-center justify-center px-4 py-2 rounded-full border text-sm leading-none transition @(isSel ? "border-black font-semibold" : "border-gray-300 hover:border-black")"
                                       title="@label">
                                        @label
                                    </a>
                                }
                            </div>
                        </div>

                        <!-- قیمت -->
                        <div class="flex items-baseline gap-3">
                            <span class="text-2xl font-semibold">@price?.Currency @saleP.ToString("0.00")</span>
                            @if (onSale)
                            {
                                <span class="line-through text-gray-500">@baseP.ToString("0.00")</span>
                                @if (off.HasValue)
                                {
                                    <span class="text-green-600 text-sm">-@off%</span>
                                }
                            }
                        </div>

                        <!-- دکمه Add to Cart -->
                        <form method="post" action="/cart/add">
                            @* اگر مسیر متفاوت داری، همین action رو با مسیر واقعی CartControllerت عوض کن *@
                            <input type="hidden" name="variantId" value="@Model.SelectedVariantId" />
                            <input type="hidden" name="qty" value="1" />
                            <button type="submit"
                                    class="inline-flex items-center justify-center bg-primary border border-transparent hover:bg-transparent hover:border-primary text-white hover:text-primary font-semibold py-3 px-6 rounded-full">
                                Add to Cart
                            </button>
                        </form>
                    </div>
                </div>
            </div> <!-- /row -->
        </div> <!-- /py -->
    </div> <!-- /container -->
</section>

<section>
    <div class="container mx-auto">
        <div class="py-12">
            <div class="mt-10">
                <div class="flex space-x-4" role="tablist">
                    <button id="features-tab" role="tab" aria-controls="features-content" aria-selected="true" class="tab active">Features & Size</button>
                    <button id="description-tab" role="tab" aria-controls="description-content" aria-selected="false" class="tab">Description</button>
                </div>
                <div class="mt-8">
                    <!-- تب ویژگی‌ها و سایز (ترکیب‌شده: نسخهٔ کاملِ main + لیست سادهٔ AddShoppingCart) -->
                    <div id="features-content"
                         role="tabpanel"
                         aria-labelledby="features-tab"
                         class="tab-content rounded-2xl p-6 md:p-8 overflow-hidden"
                         style="background-color: rgb(245,245,245) !important;">

                        @{
                            var dims = selected.Dimensions;
                            string sizePattern = (dims != null)
                                ? $"{(dims.LensWidthMm > 0 ? Math.Round(dims.LensWidthMm ?? 0) : 0)}□{(dims.BridgeWidthMm > 0 ? Math.Round(dims.BridgeWidthMm ?? 0) : 0)}–{(dims.TempleLengthMm > 0 ? Math.Round(dims.TempleLengthMm ?? 0) : 0)}"
                                : null;

                            var ordered = (selected.Images ?? Enumerable.Empty<SmartEyewearStore.Models.ProductDetailsViewModel.ImageViewModel>())
                                .OrderBy(i => i.SortOrder).ToList();
                            var thirdImg = ordered.Skip(2).FirstOrDefault() ?? ordered.LastOrDefault() ?? ordered.FirstOrDefault();
                            var smallUrl = thirdImg?.Url;
                            var smallAlt = thirdImg?.Alt ?? (Model.Name + " image");
                        }

                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-8">
                            <!-- متن (چپ) -->
                            <div class="md:flex-1 min-w-0">
                                @* از main: نمایش یک فیچر به عنوان هایلایت *@
                                @if (Model.Features?.Any() == true)
                                {
                                    <p class="font-semibold mb-4">@Model.Features.First()</p>
                                }

                                <ul class="text-[15px] leading-8">
                                    <li>
                                        <span class="text-gray-600">Size:</span>
                                        <span class="font-medium">
                                            @selected.SizeLabel
                                            @if (!string.IsNullOrWhiteSpace(sizePattern))
                                            {
                                                <text> (@sizePattern)</text>
                                            }
                                        </span>
                                    </li>
                                    <li><span class="text-gray-600">Color:</span>    <span class="font-medium underline">@selected.ColorName</span></li>
                                    <li><span class="text-gray-600">Weight:</span>   <span class="font-medium">@((dims?.WeightG)?.ToString("0") ?? "-")g</span></li>
                                    <li><span class="text-gray-600">Material:</span> <span class="font-medium">@Model.MaterialName</span></li>
                                    <li><span class="text-gray-600">Shape:</span>    <span class="font-medium">@Model.ShapeName</span></li>
                                    <li><span class="text-gray-600">Rim:</span>      <span class="font-medium">@Model.RimStyleName</span></li>
                                </ul>

                                @* از AddShoppingCart: لیست کامل Features *@
                                @if (Model.Features?.Any() == true)
                                {
                                    <div class="mt-6">
                                        <h4 class="font-semibold mb-2">All Features</h4>
                                        <ul class="list-disc pl-5">
                                            @foreach (var f in Model.Features)
                                            {
                                                <li>@f</li>
                                            }
                                        </ul>
                                    </div>
                                }

                                <p class="mt-4 text-sm">Branded case &amp; cloth</p>
                                <p class="mt-2 text-sm">
                                    Not sure about your size?
                                    <a class="text-primary font-semibold underline" href="/size-guide">Size Guide</a>
                                </p>
                            </div>

                            <!-- تصویر (راست) -->
                            <div class="md:shrink-0 md:self-center md:ml-8">
                                <figure class="md:ml-auto" style="width: 440px; max-width: 100%;">
                                    <div class="relative overflow-hidden" style="padding-top: 50%;">
                                        <img src="@smallUrl" alt="@smallAlt" class="absolute inset-0 w-full h-full object-contain" />
                                    </div>
                                </figure>
                            </div>
                        </div>
                    </div>

                    <!-- تب توضیحات -->
                    <div id="description-content"
                         role="tabpanel"
                         aria-labelledby="description-tab"
                         class="tab-content hidden rounded-2xl p-6 md:p-8 overflow-hidden"
                         style="background-color: rgb(245,245,245) !important;">
                        @using SmartEyewearStore.Models
                        @{
                            Func<ProductDetailsViewModel.ImageViewModel, string> roleOf =
                                vi => (vi?.Role ?? string.Empty).ToLowerInvariant();

                            var heroImg = selected.Images
                                .OrderBy(i => i.SortOrder)
                                .FirstOrDefault(i => roleOf(i).Contains("onface")
                                                  || roleOf(i).Contains("lifestyle")
                                                  || roleOf(i).Contains("hero")
                                                  || roleOf(i).Contains("angle"))
                                ?? selected.Images.FirstOrDefault();

                            var heroUrl = heroImg?.Url;
                            var heroAlt = heroImg?.Alt ?? (Model.Name + " image");
                        }

                        <div class="grid grid-cols-12 gap-8 items-center">
                            <div class="col-span-12 md:col-span-7">
                                <h3 class="text-2xl font-semibold mb-4">About @Model.Brand @Model.Name</h3>
                                <p class="text-gray-700 leading-relaxed">@Model.Description</p>
                            </div>
                            @* اگر خواستی دوباره تصویر کناری رو فعال کنی:
                            <div class="col-span-12 md:col-span-5">
                                <div class="bg-white rounded-xl p-4 flex items-center justify-center">
                                    <img src="@heroUrl" alt="@heroAlt" class="w-full h-auto object-contain max-h-80" />
                                </div>
                            </div>
                            *@
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    function changeImage(img) {
        var main = document.getElementById('main-image');
        if (main) main.src = img.getAttribute('data-full');
    }
</script>
