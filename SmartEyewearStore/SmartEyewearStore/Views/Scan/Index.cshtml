@section Scripts {
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const snap = document.getElementById("snap");
        const faceShapeInput = document.getElementById("faceShape");
        const skinToneInput = document.getElementById("skinTone");
        const context = canvas.getContext('2d');

        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                video.srcObject = stream;
                video.play();
            })
            .catch(err => {
                console.log("خطا: " + err);
            });

        Promise.all([
            faceapi.nets.tinyFaceDetector.loadFromUri('/models'),
            faceapi.nets.faceLandmark68Net.loadFromUri('/models')
        ]).then(() => {
            console.log("✅ مدل‌ها بارگذاری شدند!");
        });

        snap.addEventListener("click", async function () {
            context.drawImage(video, 0, 0, 300, 400);
            const detections = await faceapi.detectSingleFace(canvas, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks();

            let faceShape = "Unknown";
            let skinTone = "Unknown";

            if (detections) {
                const landmarks = detections.landmarks;
                const jawWidth = landmarks.positions[16].x - landmarks.positions[0].x;
                const faceHeight = landmarks.positions[8].y - landmarks.positions[27].y;
                const ratio = jawWidth / faceHeight;

                if (ratio > 1.3) {
                    faceShape = "Round";
                } else if (ratio > 1.1) {
                    faceShape = "Square";
                } else {
                    faceShape = "Oval";
                }

                const imgData = context.getImageData(150, 200, 10, 10).data;
                let r = 0, g = 0, b = 0, count = 0;
                for (let i = 0; i < imgData.length; i += 4) {
                    r += imgData[i];
                    g += imgData[i + 1];
                    b += imgData[i + 2];
                    count++;
                }
                r = Math.floor(r / count);
                g = Math.floor(g / count);
                b = Math.floor(b / count);

                const brightness = (r + g + b) / 3;
                if (brightness > 180) {
                    skinTone = "Light";
                } else if (brightness > 100) {
                    skinTone = "Medium";
                } else {
                    skinTone = "Dark";
                }
            }

            faceShapeInput.value = faceShape;
            skinToneInput.value = skinTone;

            document.getElementById("resultText").innerHTML = `
                ✅ فرم صورت: <b>${faceShape}</b><br>
                ✅ رنگ پوست: <b>${skinTone}</b>
            `;
        });
    </script>
}
